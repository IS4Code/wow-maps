<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<style type="text/css">
#canvas, #content, #content * {
  pointer-events: none;
}

html, body, #view, #canvas, #content {
  width: 100%;
  height: 100%;
  margin: 0;
  padding: 0;
}

#view {
  cursor: grab;
  width: 100%;
  height: 100%;
  max-width: 100%;
  max-height: 100%;
  box-sizing: border-box;
  overflow: clip;
  border: 3px groove buttonborder;
  background-color: canvas;
}

#view:active {
  cursor: grabbing;
}

#content {
  transform: matrix(0.125, 0, 0, 0.125, 0, 0);
  transform-origin: 0 0;
  transition: transform 0s;
  
  position: relative;
}

#content * {
  position: absolute;
  top: 0;
  left: 0;
}

.fallback {
  transform: scale(2);
  transform-origin: 0 0;
}

#controls {
  position: fixed;
  top: 0;
  right: 0;
  margin: 32px;
  display: inline-block;
}

#controls fieldset, #controls legend {
  background-color: canvas;
}

#controls fieldset {
  margin: 0;
  border-radius: 8px;
}

#controls legend {
  padding: 4px 8px;
  border-radius: 4px;
}

#controls table {
  border-spacing: 16px;
}

#controls table input {
  vertical-align: middle;
}

#layers {
  width: 100%;
  overflow-y: auto;
}
</style>
</head>
<body>
<!-- The scrollable container of the map -->
<main id="view">
<!-- The parent to which transformations are calculated -->
<section id="canvas">
<!-- The visual content that is transformed -->
<figure id="content">
</figure>
</section>
</main>
<aside id="controls">
<form autocomplete="off">
<fieldset>
<legend>Controls</legend>
<label><input type="radio" name="continent" value="Azeroth" onchange="setContinent('Azeroth')" checked>Eastern Kingdoms</label>
<label><input type="radio" name="continent" value="Kalimdor" onchange="setContinent('Kalimdor')">Kalimdor</label>
<table>
<tr>
<td>
<label>Layers:<br>
<select id="layers" size="1" onchange="selectLayer()"></select><br>
<label>Add layer: <select id="addlayer" onchange="addSelectedLayer()">
<optgroup id="Azeroth" label="Eastern Kingdoms">
<option value="0.5.3/Azeroth">0.5.3 Minimap</option>
<option value="0.0.2003.5/Azeroth">0.5.3 TaxiMap00</option>
<option value="0.9.1/Azeroth">0.9.1 Minimap</option>
<option value="1.0.0/Azeroth">1.0.0 Minimap</option>
</optgroup>
<optgroup id="Kalimdor" label="Kalimdor" style="display:none">
<option value="0.5.3/Kalimdor">0.5.3 Minimap</option>
<option value="0.0.2003.7/Kalimdor">0.5.3 TaxiMap01</option>
<option value="0.9.1/Kalimdor">0.9.1 Minimap</option>
<option value="1.0.0/Kalimdor">1.0.0 Minimap</option>
</optgroup>
</select></label>
</label>
</td>
<td>
<label>Opacity: <input type="range" id="opacity" min="0" max="100" value="100" oninput="updateLayer()" onchange="updateLayer()"></label><br>
<label>Blend: <select id="blend" onchange="updateLayer()">
<option value="normal" selected>normal</option>
<option value="multiply">multiply</option>
<option value="screen">screen</option>
<option value="overlay">overlay</option>
<option value="darken">darken</option>
<option value="lighten">lighten</option>
<option value="color-dodge">color-dodge</option>
<option value="color-burn">color-burn</option>
<option value="hard-light">hard-light</option>
<option value="soft-light">soft-light</option>
<option value="difference">difference</option>
<option value="exclusion">exclusion</option>
<option value="hue">hue</option>
<option value="saturation">saturation</option>
<option value="color">color</option>
<option value="luminosity">luminosity</option>
<option value="plus-darker">plus-darker</option>
<option value="plus-lighter">plus-lighter</option>
</select></label><br>
<button type="button" onclick="removeSelectedLayer()">Remove layer</button>
</td>
</tr>
</table>
</fieldset>
</form>
</aside>
<script type="text/javascript">
var view = document.getElementById('view');
var canvas = document.getElementById('canvas');
var content = document.getElementById('content');

var layers = document.getElementById('layers');
var opacity = document.getElementById('opacity');
var blend = document.getElementById('blend');
var addlayer = document.getElementById('addlayer');
addlayer.value = null;
var lastLayerIndex = 0;

var continent = 'Azeroth';

var zoom = 0.125;
var zoomFactor = 1.001;
var zoomLimit = 32;

var xTranslate = 0;
var yTranslate = 0;

view.addEventListener('mousemove', event => {
  if(event.buttons & 1)
  {
    xTranslate += event.movementX;
    yTranslate += event.movementY;
    
    content.style.transition = 'transform 0s';
    content.style.transform = `matrix(${zoom}, 0, 0, ${zoom}, ${xTranslate}, ${yTranslate})`;
  }
});

view.addEventListener('wheel', event => {
  event.preventDefault();
  
  zoom *= Math.pow(zoomFactor, -event.deltaY);
  
  if(zoom > zoomLimit) zoom = zoomLimit;
  else if(zoom < 1/zoomLimit) zoom = 1/zoomLimit;
  
  var canvasRect = canvas.getBoundingClientRect();
  // Position relative to the canvas (untransformed)
  var xCanvas = event.clientX - canvasRect.left;
  var yCanvas = event.clientY - canvasRect.top;
  
  var contentRect = content.getBoundingClientRect();
  // Position relative to the content origin
  var xContent = event.clientX - contentRect.left;
  var yContent = event.clientY - contentRect.top;
  var xContentRel = xContent / contentRect.width;
  var yContentRel = yContent / contentRect.height;
  // Position of the untransformed content 
  xContent = xContentRel * content.offsetWidth;
  yContent = yContentRel * content.offsetHeight;
  
  // Translate coordinates: move content position to top-left (undo scaling by zoom), then move to canvas position
  xTranslate = xCanvas - xContent * zoom;
  yTranslate = yCanvas - yContent * zoom;
  
  content.style.transition = zoom >= 0.25 ? 'transform 0.15s' : 'transform 0.05s';
  content.style.transform = `matrix(${zoom}, 0, 0, ${zoom}, ${xTranslate}, ${yTranslate})`;
});

function updateLayer()
{
  var index = layers.value;
  var layer = document.getElementById('layer' + index);
  
  layer.style.opacity = opacity.value / 100;
  layer.style.mixBlendMode = blend.value;
}

function selectLayer()
{
  var index = layers.value;
  var layer = document.getElementById('layer' + index);
  
  opacity.value = layer.style.opacity * 100;
  blend.value = layer.style.mixBlendMode;
}

function addLayer(name, path)
{
  lastLayerIndex++;
  
  var option = document.createElement('option');
  option.setAttribute('value', lastLayerIndex);
  option.innerText = lastLayerIndex + ": " + name;
  layers.insertBefore(option, layers.firstChild);
  layers.setAttribute('size', layers.childElementCount);
  layers.value = lastLayerIndex;
  
  var layer = document.createElement('object');
  layer.setAttribute('id', 'layer' + lastLayerIndex);
  layer.setAttribute('data', path + '.svg');
  layer.setAttribute('type', 'image/svg+xml');
  
  layer.style.opacity = 1;
  layer.style.mixBlendMode = 'normal';
  
  content.appendChild(layer);
}

function addSelectedLayer()
{
  var path = addlayer.value;
  var name = addlayer.options[addlayer.selectedIndex].text;
  addlayer.value = null;
  
  addLayer(name, path);
}

function removeSelectedLayer()
{
  document.getElementById('layer' + layers.value).remove();
  layers.options[layers.selectedIndex].remove();
  
  if(layers.childElementCount == 0)
  {
    lastLayerIndex = 0;
  }
}

function setContinent(newContinent)
{
  layers.innerHTML = "";
  content.innerHTML = "";
  lastLayerIndex = 0;
  
  document.getElementById(continent).style.display = 'none';
  document.getElementById(newContinent).style.display = 'initial';
  continent = newContinent;
}

addLayer("0.5.3 Minimap", '0.5.3/Azeroth');
</script>
</body>
</html>